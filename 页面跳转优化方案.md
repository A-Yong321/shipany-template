# 系统性能优化方案

优化页面跳转速度和资源加载效率。核心目标：页面跳转毫秒级（最慢 <3s），消除重复资源加载，实现按需/懒加载。

## 问题诊断总结

经过对项目代码的全面分析，发现以下性能瓶颈：

| 问题 | 文件 | 影响程度 |
|------|------|----------|
| 轮播图4x复制数组，所有图片/视频同时加载 | [hero-showcase.tsx](file:///d:/shipany-template/src/themes/default/blocks/hero-showcase.tsx) | 高 |
| 使用原生 `<img>` 而非 next/image，视频无懒加载 | [ai-style-effects.tsx](file:///d:/shipany-template/src/themes/default/blocks/ai-style-effects.tsx) | 高 |
| 大量硬编码图片/视频无懒加载 | [inspirations.tsx](file:///d:/shipany-template/src/themes/default/blocks/inspirations.tsx) | 中 |
| 所有效果卡片一次性渲染，无分页/虚拟化 | [explore-masonry.tsx](file:///d:/shipany-template/src/themes/default/blocks/explore-masonry.tsx) | 中 |
| LazyImage 使用第三方库，未利用 next/image 优化 | [lazy-image.tsx](file:///d:/shipany-template/src/shared/blocks/common/lazy-image.tsx) | 中 |
| 效果卡片图片缺少 sizes 优化 | [effect-card.tsx](file:///d:/shipany-template/src/themes/default/blocks/effect-card.tsx) | 低 |
| 翻译消息一次性全量加载到客户端 | `[locale]/layout.tsx` | 中 |
| Link 组件默认 prefetch 导致预加载过多 | 多个组件 | 中 |

## Proposed Changes

### 组件一：图片懒加载基础设施

重写 LazyImage 组件，用 next/image 替代 react-lazy-load-image-component，获得自动 WebP 转换、响应式 srcset、内置懒加载等优化。

#### [MODIFY] [lazy-image.tsx](file:///d:/shipany-template/src/shared/blocks/common/lazy-image.tsx)

- 移除 `react-lazy-load-image-component` 依赖
- 使用 next/image 组件替代，配合 `loading="lazy"` 和 `placeholder="blur"` 
- 保持原有 API 接口兼容，增加 `sizes` 参数支持
- 添加 `blurDataURL` 占位图支持（使用极小 base64 占位）

---

### 组件二：首页轮播优化

#### [MODIFY] [hero-showcase.tsx](file:///d:/shipany-template/src/themes/default/blocks/hero-showcase.tsx)

- 将4x数组复制减少到2x（Swiper loop 只需2x即可正常工作）
- 为轮播图片添加合适的 `sizes` 属性（移动端100px，桌面端140px）
- 视频改为 `preload="none"`，只在可见且hover时才加载播放
- 效果图使用 `loading="lazy"`，非首屏图片不用 `priority`

---

### 组件三：AI 特效列表优化

#### [MODIFY] [ai-style-effects.tsx](file:///d:/shipany-template/src/themes/default/blocks/ai-style-effects.tsx)

- 将原生 `<img>` 标签替换为 next/image `<Image>` 组件
- 添加 `loading="lazy"` 和正确的 `sizes` 属性
- 视频元素添加 `preload="none"`，仅 hover 时通过 `onMouseEnter` 触发 `src` 赋值和播放
- 实现分批渲染：初始只展示前12个卡片，用 IntersectionObserver 滚动到底部时加载更多

---

### 组件四：Explore 瀑布流优化

#### [MODIFY] [explore-masonry.tsx](file:///d:/shipany-template/src/themes/default/blocks/explore-masonry.tsx)

- 添加分批渲染逻辑：初始渲染20个条目，IntersectionObserver 触底时追加20个
- 为 Image 组件添加 `loading="lazy"` 属性
- Link 组件增加 `prefetch={false}` 防止不必要的预加载

---

### 组件五：Inspirations 组件优化

#### [MODIFY] [inspirations.tsx](file:///d:/shipany-template/src/themes/default/blocks/inspirations.tsx)

- Image 组件添加 `sizes` 属性优化加载尺寸
- 视频改为延迟加载：hover 时才设置 `src` 属性并播放，而非条件渲染整个 video 元素
- 添加 `loading="lazy"` 确保非可视区域图片不加载

---

### 组件六：Link prefetch 策略优化

#### [MODIFY] [showcases-flow.tsx](file:///d:/shipany-template/src/themes/default/blocks/showcases-flow.tsx)

- 为 showcases 的 Link/Button 添加 `prefetch={false}`

#### [MODIFY] [header.tsx](file:///d:/shipany-template/src/themes/default/blocks/header.tsx)

- 导航链接保持默认 prefetch（核心导航路径需要快速跳转）

---

### 组件七：视频懒加载工具组件

#### [NEW] [lazy-video.tsx](file:///d:/shipany-template/src/shared/blocks/common/lazy-video.tsx)

- 创建统一的 `LazyVideo` 组件
- 使用 IntersectionObserver 检测可见性
- 仅在可见+hover 时加载视频（设置 `preload="none"`，hover时调用 `play()`）
- 提供 `poster` 属性用于视频加载前显示封面图
- 支持 `autoPlayOnVisible` 选项用于轮播等场景

---

### 组件八：Next.js 配置优化

#### [MODIFY] [next.config.mjs](file:///d:/shipany-template/next.config.mjs)

- 为静态资源添加更多缓存规则（`/videos/:path*`）
- 优化 images 配置：降低默认质量以加速加载（`qualities: [50, 60, 70]`）

## Verification Plan

### 浏览器测试

由于项目不含单元测试，验证将通过浏览器实际操作完成：

1. **首页加载测试**
   - 启动 `npm run dev`，在浏览器打开 `http://localhost:3000`
   - 检查首页加载是否正常渲染，轮播图是否正常滚动
   - 打开浏览器 Network 面板，验证图片是否按需加载（滚动到可见区域才触发请求）

2. **页面跳转测试**
   - 从首页点击导航菜单跳转到 Effects 页面
   - 从 Effects 页面点击效果卡片跳转到工具详情页
   - 验证每次跳转流畅无长时间白屏

3. **Explore 页面滚动测试**
   - 打开 Explore / AI Style 页面
   - 滚动页面，验证图片是否懒加载（Network 面板中观察请求时机）
   - 确认视频仅在 hover 时加载

4. **构建验证**
   - 运行 `npm run build` 确保无编译错误

> [!IMPORTANT]
> 以上测试在开发环境 (`npm run dev`) 下进行。Next.js 的 Image 优化和缓存在 production build 中效果更显著，但开发环境可以验证功能正确性和基本的懒加载行为。
