# AI Studio API å…¨æ ˆå¯¹æ¥æŒ‡å— (Next.js)

åŸºäºå®é™…éªŒè¯é€šè¿‡çš„æ¥å£è§„èŒƒï¼Œæœ¬æŒ‡å—è¯¦ç»†è¯´æ˜äº†å¦‚ä½•åœ¨æœ¬é¡¹ç›®ä¸­å®ç°ä»å‰ç«¯åˆ°åç«¯çš„å®Œæ•´å¯¹æ¥é€»è¾‘ã€‚

---

## 1. æ ¸å¿ƒåè®®å±‚ (AI Provider)

**æ–‡ä»¶è·¯å¾„**: `src/extensions/ai/aistudio.ts`

è¯¥æ–‡ä»¶è´Ÿè´£æœ€åº•å±‚çš„ API è°ƒç”¨ï¼Œå¿…é¡»å¤„ç† Grok å¹³å°çš„åµŒå¥—å“åº”ç»“æ„ã€‚

### å›¾ç‰‡ç”Ÿæˆè¯·æ±‚é€‚é…
å¿…é¡»åŒ…å« `action: 'generate'` å‚æ•°ã€‚

```typescript
private async generateImage(params: AIGenerateParams): Promise<AITaskResult> {
  const platform = this.getPlatformByModel(params.model, 'grok');
  const body = {
    action: 'generate', // âœ… å…³é”®ï¼šå¿…éœ€å‚æ•°
    prompt: params.prompt,
    model: params.model,
    size: params.options?.size || '1024x1024',
    count: params.options?.count || 1,
  };
  // ... å‘é€è¯·æ±‚ ...
}
```

### ä»»åŠ¡æŸ¥è¯¢å“åº”è§£æ
å¿…é¡»å…¼å®¹ `response.data` åµŒå¥—ç»“æ„å’Œ `imageUrls` å­—æ®µåã€‚

```typescript
async query(taskId: string): Promise<AITaskResult> {
  const res = await fetch(url, { ... });
  const data = await res.json();

  // âœ… 1. çŠ¶æ€åˆ¤æ–­é€»è¾‘
  let status = AITaskStatus.PENDING;
  if (data.status === 'succeeded' || data.response?.success) {
    status = AITaskStatus.SUCCESS;
  } else if (data.status === 'failed' || (data.finished_at && !data.response?.success)) {
    status = AITaskStatus.FAILED;
  }

  // âœ… 2. æ•°æ®æå–é€»è¾‘ (å…³é”®ï¼šå¤„ç†åµŒå¥—)
  const resultData = data.response?.data || data;
  const images = resultData.images || 
    (resultData.imageUrls ? resultData.imageUrls.map((url: string) => ({ url })) : null);
  
  return { taskId, taskStatus: status, taskResult: data, taskInfo: { images } };
}
```

---

## 2. æœåŠ¡ç«¯è·¯ç”±å±‚ (API Routes)

**ä¸»è¦æ–‡ä»¶**: 
- `src/app/api/ai/generate/route.ts` (ä»»åŠ¡åˆ›å»º)
- `src/app/api/ai/query/route.ts` (çŠ¶æ€è½®è¯¢)

### ä»»åŠ¡æŸ¥è¯¢è·¯ç”±å…³é”®é€»è¾‘
å½“ä»»åŠ¡å¤±è´¥æ—¶ï¼Œå¿…é¡»é€€è¿˜ç”¨æˆ·é¢åº¦ã€‚

```typescript
// src/app/api/ai/query/route.ts æ ¸å¿ƒä¼ªä»£ç 
export async function POST(req: Request) {
  const { taskId } = await req.json();
  const result = await aiService.queryTask(taskId);

  // å¦‚æœçŠ¶æ€å‘ç”Ÿå˜æ›´ï¼Œæ›´æ–°æ•°æ®åº“
  if (result.taskStatus !== cachedStatus) {
    await db.updateTask(taskId, result.taskStatus);
    
    // âœ… å¤±è´¥é€€è¿˜é¢åº¦
    if (result.taskStatus === 'failed') {
      await creditService.refund(userId, amount);
    }
  }
  
  return NextResponse.json(result);
}
```

---

## 3. å‰ç«¯äº¤äº’å±‚ (Client Components)

**æ–‡ä»¶è·¯å¾„**: `src/themes/default/blocks/text-to-image/context.tsx`

å‰ç«¯éœ€è¦å®ç°å¥å£®çš„è½®è¯¢é€»è¾‘ï¼Œå¹¶èƒ½è¯†åˆ«å¤šç§æˆåŠŸæ ‡å¿—ã€‚

### è½®è¯¢çŠ¶æ€è¯†åˆ«

```typescript
// å‰ç«¯è½®è¯¢ä¸­çš„åˆ¤æ–­
if (
  data.status === 'success' ||      // âœ… å…¼å®¹ Grok/Flux è¿”å›çš„å°å†™çŠ¶æ€
  data.status === 'succeeded' ||    // å…¼å®¹æ ‡å‡†æ ¼å¼
  data.status === 'SUCCESS'         // å…¼å®¹å…¶ä»– Provider
) {
  setLoading(false);
  setResult(data.taskResult); // å±•ç¤ºå›¾ç‰‡
}
```

---

## ğŸ”— æ•°æ®æµå…¨è§ˆ

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ· (æµè§ˆå™¨)
    participant Client as Frontend (Next.js Client)
    participant Route as API Route (Server)
    participant Provider as AIStudioProvider (Node.js)
    participant Remote as AI Studio API (Remote)

    User->>Client: ç‚¹å‡»ç”ŸæˆæŒ‰é’®
    Client->>Route: POST /api/ai/generate (å¸¦æç¤ºè¯)
    Route->>Route: æ‰£é™¤ 4 ä¿¡ç”¨åˆ†
    Route->>Provider: generate({ prompt })
    Provider->>Remote: POST /api/grok/images (action='generate')
    Remote-->>Provider: è¿”å› task_id
    Provider-->>Route: è¿”å› task_id
    Route-->>Client: è¿”å› task_id
    
    loop è½®è¯¢ä»»åŠ¡çŠ¶æ€
        Client->>Route: POST /api/ai/query (task_id)
        Route->>Provider: query(task_id)
        Provider->>Remote: POST /api/grok/tasks (task_id)
        Remote-->>Provider: è¿”å›åµŒå¥— JSON (response.data.imageUrls)
        Provider-->>Route: è§£æä¸ºç»Ÿä¸€æ ¼å¼
        Route-->>Client: è¿”å›ç»“æœ
    end
    
    Client->>User: æ˜¾ç¤º AI ç”Ÿæˆçš„å›¾ç‰‡
```

---

## ğŸ’¡ å¸¸è§é”™è¯¯æ’æŸ¥

1. **ä¸€ç›´ Loading?** 
   - æ£€æŸ¥å‰ç«¯ `context.tsx` æ˜¯å¦åœ¨åˆ¤æ–­ `data.status === 'success'`ã€‚Grok è¿”å›çš„æ˜¯å°å†™ã€‚
2. **è¯·æ±‚ 400?** 
   - æ£€æŸ¥åç«¯ `aistudio.ts` æ˜¯å¦æ¼ä¼ äº† `action: 'generate'`ã€‚
3. **å›¾ç‰‡ä¸æ˜¾ç¤º?** 
   - æ£€æŸ¥ `query` è§£æé€»è¾‘ã€‚å›¾ç‰‡å¯èƒ½åœ¨ `response.data.imageUrls` é‡Œï¼Œè€Œä¸æ˜¯é¡¶å±‚çš„ `images`ã€‚

---

## âœ… ç»“è®º

éµå¾ªæœ¬æŒ‡å—ç¼–å†™ä»£ç ï¼Œå¯ä»¥ç¡®ä¿å‰åç«¯å®Œå…¨å¯¹é½ **AI Studio** çš„çœŸå®åè®®ï¼Œé¿å…å› ä¸ºæ–‡æ¡£é™ˆæ—§å¯¼è‡´çš„å„ç§â€œè¯¡å¼‚â€é—®é¢˜ã€‚
